I"Ö6<font face="ä»¿å®‹">åŸºäºæ·±åº¦å­¦ä¹ æ–‡æœ¬åˆ†ç±»çš„ç½‘ç»œæ–°é—»æƒ…æ„ŸæŒ‡æ•°ç¼–åˆ¶ï¼ˆäºŒï¼‰<br />è¿‡æ»¤æ— ç”¨æ–°é—»</font>
<style>
    body {font-family: "åæ–‡ä¸­å®‹"}
</style>

<h3 id="main-step-2delete-useless-news-and-then-combine-them">Main step 2:<center>delete useless news and then combine them</center></h3>
<h4 id="description-1">description 1:</h4>
<ul>
  <li>delete duplicated,foreign news and ads</li>
  <li>conbine the news of each class into <code class="highlighter-rouge">all_df.csv</code></li>
  <li>obtain summary.xlsx according to <code class="highlighter-rouge">all_df.csv</code>
    <h4 id="code-explanation">code explanation:</h4>
    <ol>
      <li>conbine the news and delete the duplicated</li>
    </ol>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">batch_read_csv</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">"gb18030"</span><span class="p">):</span>
    <span class="n">file_names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">)</span>
    <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_names</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r"title.csv"</span><span class="p">,</span><span class="n">f</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#åªè¯»å–åç¼€åä¸ºcsvçš„æ–‡ä»¶
</span>    <span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_names</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">,</span><span class="n">file_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">,</span><span class="n">file_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span><span class="n">engine</span> <span class="o">=</span>  <span class="s">"python"</span><span class="p">)</span>

        <span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_df</span><span class="p">,</span><span class="n">temp_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1">#        print(all_df.head())
</span>    <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_df</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"å¤„ç†å‰æ–°é—»æœ‰</span><span class="si">%</span><span class="s">dæ¡"</span><span class="o">%</span><span class="p">(</span><span class="n">l1</span><span class="p">))</span>
    <span class="c1">#å»é‡
</span>    <span class="n">var_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">var_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">"keyword"</span><span class="p">)</span>
    <span class="n">all_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">var_list</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="c1">#åªæœ‰å®Œå…¨ä¸€æ ·çš„æ‰åˆ é™¤
</span>    <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_df</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"åˆ é™¤é‡å¤æ–°é—»</span><span class="si">%</span><span class="s">dæ¡"</span><span class="o">%</span><span class="p">(</span><span class="n">l1</span><span class="o">-</span><span class="n">l2</span><span class="p">))</span>
<span class="c1">#    all_df.to_csv("F:/æ¯•ä¸šè®ºæ–‡/raw_data/ç»æµ/economics.csv",encoding="gb18030",index=False)
</span>    <span class="c1">#all_dfåˆ é™¤é‡å¤è¡Œåï¼Œindexæœ‰ç©ºç¼ºï¼Œé‡æ–°ç´¢å¼•
</span>    <span class="n">all_df</span> <span class="o">=</span> <span class="n">all_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_df</span>
</code></pre></div></div>
<ol>
  <li>delete foreign news according to <code class="highlighter-rouge">countryname.txt</code>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># æ ¹æ®countryname.txtæŸ¥æ‰¾å«æœ‰å¤–å›½å›½å®¶åçš„æ–°é—»
</span><span class="k">def</span> <span class="nf">is_foreign_name</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
 <span class="n">countryname</span> <span class="o">=</span>  <span class="nb">open</span><span class="p">(</span><span class="s">"./code/countryname.txt"</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
 <span class="n">isforeign</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">text</span><span class="p">))</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">countryname</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span>
 <span class="n">notchina</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">text</span><span class="p">))</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"åŒ—äº¬"</span><span class="p">,</span><span class="s">"ä¸­å›½"</span><span class="p">,</span><span class="s">"å†…è’™å¤"</span><span class="p">]])</span><span class="o">==</span><span class="mi">0</span>
 <span class="k">return</span>  <span class="n">isforeign</span> <span class="ow">and</span> <span class="n">notchina</span>
</code></pre></div>    </div>
  </li>
  <li>delete ads according to <code class="highlighter-rouge">ad_web.txt</code>
```python
    <h1 id="æ ¹æ®ad_webtxtæŸ¥æ‰¾æ¥è‡ªäºå¹¿å‘Šç½‘ç«™çš„æ–°é—»">æ ¹æ®ad_web.txtæŸ¥æ‰¾æ¥è‡ªäºå¹¿å‘Šç½‘ç«™çš„æ–°é—»</h1>
    <p>def is_ad_web(text):
 ad_web = open(â€œ./code/ad_web.txtâ€,â€™rbâ€™).read().decode(â€˜utf-8â€™).split(â€œ\r\nâ€)
 isadweb = sum([text==token for token in ad_web])
 return isadweb</p>
  </li>
</ol>

<h1 id="åˆ é™¤å¤–å›½æ–°é—»å’Œå¹¿å‘Š">åˆ é™¤å¤–å›½æ–°é—»å’Œå¹¿å‘Š</h1>
<p>def rm_foreign_news(full_class_name):
    all_df = batch_read_csv(full_class_name)
    is_foreign = all_df[â€œtitleâ€].apply(is_foreign_name)
    is_foreign = np.array(is_foreign)
    dele_num = np.where(is_foreign&gt;0)[0]</p>
<h1 id="all_dftitledele_num">all_df[â€œtitleâ€][dele_num]</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>all_df.drop(dele_num,inplace = True)
all_df = all_df.reset_index(drop=True)
print("åˆ é™¤å¤–å›½æ–°é—»%dæ¡"%len(dele_num))
ad_web = np.array(all_df["source"].apply(is_ad_web))
dele_num = np.where(ad_web==1)[0]
all_df.drop(dele_num,inplace = True)
print("åˆ é™¤å¹¿å‘Šæ–°é—»%dæ¡"%len(dele_num))

all_df = all_df.reset_index(drop=True)    
return all_df ```
</code></pre></div></div>

<ol>
  <li>
    <p>delete news in unnecessary time
```python
def dele_wrongtime(full_class_name,bt_ymd,et_ymd):
 â€œâ€â€
 full_class_name,æ–°é—»ç±»åˆ«å
 bt_ymd,å¼€å§‹æ—¶é—´
 et_ymdï¼Œç»“æŸæ—¶é—´
 â€œâ€â€</p>

    <p>all_df = rm_foreign_news(full_class_name)</p>

    <p>#ç»Ÿè®¡å¹´ä»½å­£åº¦çš„æ–°é—»æ•°:æ–°å¢å¹´ä»½åˆ—ä¸å­£åº¦åˆ—
 time = pd.to_datetime(all_df[â€œdateâ€],format=â€%Yå¹´%mæœˆ%dæ—¥â€)
 dele_num1 = np.where(bt_ymd&gt;time)[0]
 dele_num2 = np.where(time&gt;et_ymd)[0]
 dele_num = np.append(dele_num1 , dele_num2)
 print(â€œåˆ é™¤ééœ€è¦æ—¶é—´æ®µæ–°é—»%dæ¡â€%len(dele_num))
 all_df.drop(dele_num,inplace = True)
 all_df = all_df.reset_index(drop=True)
 print(â€œå¤„ç†åæ–°é—»æœ‰%dæ¡â€%(len(all_df)))
 return all_df</p>
  </li>
</ol>

<p>def get_all_df(path,bt_ymd,et_ymd):
    class_names  = os.listdir(path)
    for class_name in class_names:
        print(â€œæ­£åœ¨åˆå¹¶ã€%sã€‘ç±»æ–°é—»â€¦â€¦â€œ%class_name)
        full_class_name = os.path.join(path,class_name)</p>
<h1 id="all_df--batch_read_csvfull_class_name--åŸç‰ˆ">all_df = batch_read_csv(full_class_name)  #åŸç‰ˆ</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    all_df = dele_wrongtime(full_class_name,bt_ymd,et_ymd)
    all_df.to_csv(os.path.join(full_class_name,class_name+"all_df.csv"),encoding="gb18030",index=False)    
</code></pre></div></div>

<h1 id="ç”Ÿæˆåˆå¹¶å¤„ç†ç‰ˆ">ç”Ÿæˆåˆå¹¶å¤„ç†ç‰ˆ</h1>
<p>path = â€œ./renew_dataâ€
bt_ymd = â€œ2018-07-01â€
et_ymd = â€œ2019-06-30â€
get_all_df(path,bt_ymd,et_ymd)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
5. obtain summary table
```python
def onestat(param):
    full_class_name,excel_writer = param
    class_name = os.path.split(full_class_name)[1]
    all_df = pd.read_csv(os.path.join(full_class_name,class_name+"all_df.csv"),encoding="gb18030")
    
    source_websites = list(all_df["source"].value_counts().index)[:15]
    keywords = list(all_df["keyword"].value_counts().index)
    ram = np.random.randint(0, high=len(all_df)-1, size=4, dtype='l')
    examples = all_df.ix[ram,"title"]
    examples = "\n".join(examples)
    
    time = pd.to_datetime(all_df["date"],format="%Yå¹´%mæœˆ%dæ—¥")
    all_df["year"] = list(pd.DatetimeIndex(time).year)
    all_df["quarter"] = list(pd.DatetimeIndex(time).quarter)
    
    date_stat = all_df["title"].groupby([all_df["year"],all_df["quarter"]]).count()
    date_stat.to_excel(excel_writer,class_name)
    return source_websites,keywords,len(all_df),examples

def allstat(path,writer):
    classes = os.listdir(path)
    subpaths = [os.path.join(path,sp) for sp in os.listdir(path)]
    param = [(sp,writer) for sp in subpaths]      
    result = list(map(onestat,param))   
    source_websites = [[tup[0] for tup in result]][0]
    source_websites_str = ["ï¼Œ".join(name) for name in source_websites]
    keywords = [[tup[1] for tup in result]][0]
    keywords_str = ["ï¼Œ".join(k) for k in keywords]
    num_class = [tup[2] for tup in result]
    examples = [tup[3] for tup in result]
    summary = pd.DataFrame(data = np.array([classes,keywords_str,source_websites_str,num_class,examples]).T,
                                           columns = ["class","keywords","source","num_class","examples"])

    
    summary.to_excel(writer,'summary')
    writer.save()
    print("excelå·²ç”Ÿæˆï¼Œè¯·æ‰“å¼€ã€"+os.getcwd()+"ã€‘æŸ¥çœ‹è¯¦æƒ…")

path = "./renew_data"
# ç»Ÿè®¡æ–°é—»ä¿¡æ¯
writer = pd.ExcelWriter('summary.xlsx')
allstat(path,writer)
</code></pre></div></div>
:ET