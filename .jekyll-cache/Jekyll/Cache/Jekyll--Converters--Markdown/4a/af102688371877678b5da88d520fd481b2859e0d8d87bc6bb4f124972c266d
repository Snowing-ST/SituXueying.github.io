I"å<font face="ä»¿å®‹">â€œåŠè‡ªåŠ¨â€æŒ‡éªŒè¯ç è¿˜éœ€æ‰‹åŠ¨å¡«å†™o(â•¥ï¹â•¥)o</font>

<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>

<h3 id="ä»£ç æ­¥éª¤">ä»£ç æ­¥éª¤</h3>
<h4 id="1-æ‰‹åŠ¨å¡«å†™å‘ç¥¨ä¿¡æ¯">1. æ‰‹åŠ¨å¡«å†™å‘ç¥¨ä¿¡æ¯</h4>
<p>å‘ç¥¨ä¿¡æ¯å¦‚å‘ç¥¨ä»£ç ã€å‘ç¥¨å·ç ã€å‘ç¥¨æ—¶é—´ã€ç¨å‰é‡‘é¢éœ€å…ˆè¡Œå¡«å†™åœ¨excelä¸­ï¼Œå¦‚<a href="https://github.com/Snowing-ST/invoice_checking/blob/master/invoice_sample.xlsx">invoice_sample.xlsx</a>æ‰€ç¤º</p>

<table>
  <thead>
    <tr>
      <th>ä¸šåŠ¡ç¼–å·</th>
      <th>å‘ç¥¨ä»£ç </th>
      <th>å‘ç¥¨å·ç </th>
      <th>å‘ç¥¨æ—¥æœŸ</th>
      <th>ç¨å‰é‡‘é¢</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ABC2019FP00004</td>
      <td>3400183130</td>
      <td>02049280</td>
      <td>20181225</td>
      <td>471495.24</td>
    </tr>
    <tr>
      <td>ABC2019FP00004</td>
      <td>3400183130</td>
      <td>02049281</td>
      <td>20181225</td>
      <td>937220.75</td>
    </tr>
  </tbody>
</table>

<pre class="prettyprint"><code class="language-py">
import os
import pandas as pd
# å»ºç«‹æˆªå›¾ã€ä¸å­˜æ”¾æˆªå›¾çš„æ–‡æ¡£æ–‡ä»¶å¤¹
if not os.path.exists(screenshot_save_path):
    os.mkdir(screenshot_save_path) 
if not os.path.exists(doc_save_path):
    os.mkdir(doc_save_path) 
#ç›´æ¥é»˜è®¤è¯»å–åˆ°è¿™ä¸ªExcelçš„ç¬¬ä¸€ä¸ªè¡¨å•
invoice_info = pd.read_excel(invoice_file_path,dtype="str")
invoice_info.head()
</code></pre>

<h4 id="2-è‡ªåŠ¨å¡«å†™è¡¨å•">2. è‡ªåŠ¨å¡«å†™è¡¨å•</h4>
<p>è¿è¡Œ<a href="https://github.com/Snowing-ST/invoice_checking/blob/master/invoice_checking.py">invoice_checking.py</a>,æç¤ºå¡«å†™excelè¡¨æ ¼çš„è·¯å¾„ï¼Œå¡«å†™å®Œæ¯•å›è½¦åï¼Œseleniumåº“çš„webdriverå°†æ‰“å¼€è°·æ­Œæµè§ˆå™¨ï¼Œè‡ªåŠ¨ç™»é™†<a href="https://inv-veri.chinatax.gov.cn/index.html">å›½å®¶ç¨åŠ¡æ€»å±€å…¨å›½å¢å€¼ç¨å‘ç¥¨æŸ¥éªŒå¹³å°</a>ï¼Œè‡ªåŠ¨å¡«å†™å‘ç¥¨ä¿¡æ¯ï¼Œ<strong>éªŒè¯ç éœ€æ‰‹åŠ¨è¾“å…¥ç¨‹åºç«¯ï¼Œä¸èƒ½è¾“åœ¨ç½‘é¡µä¸Š</strong>ï¼Œå¦‚æœè¾“é”™ç­‰å¾…æµè§ˆå™¨è‡ªåŠ¨è·³è½¬ï¼Œ<strong>ä¸è¦ç‚¹å‡»æµè§ˆå™¨ä»»ä½•æŒ‰é’®</strong>ï¼Œå†æ¬¡åœ¨ç¨‹åºç«¯è¾“å…¥éªŒè¯ç ã€‚</p>

<ul>
  <li>
    <font size="2"> æ³¨ï¼šä½¿ç”¨seleniumåº“çš„webdriveræ‰“å¼€è°·æ­Œæµè§ˆå™¨éœ€åˆ°[æ­¤å¤„](http://chromedriver.storage.googleapis.com/index.html)ä¸‹è½½chromedriver.exeï¼Œæ³¨æ„ä¸‹è½½ç‰ˆæœ¬ä¸€å®šè¦å’Œç”µè„‘ä¸­è°·æ­Œæµè§ˆå™¨ç‰ˆæœ¬ä¸€è‡´ï¼å¹¶å°†è¯¥æ–‡ä»¶æ”¾å…¥excelæ–‡ä»¶çš„ç›®å½•ä¸‹ï¼ˆå¯åœ¨ä»£ç ä¸­ä¿®æ”¹å­˜æ”¾è·¯å¾„ï¼‰</font>
  </li>
</ul>

<pre class="prettyprint"><code class="language-py">
from selenium import webdriver
from selenium.webdriver.common.action_chains import ActionChains
from selenium.common.exceptions import StaleElementReferenceException

## å¯åŠ¨web driver
driver = webdriver.Chrome(os.path.join(path,"chromedriver.exe"))
driver.maximize_window()

# æ‰‹åŠ¨è¾“å…¥éªŒè¯ç 
def yzm(driver,invoice_num):
    print("æ­£åœ¨æŸ¥éªŒå‘ç¥¨%s..." % invoice_num)
    code = input("è¯·è¾“å…¥éªŒè¯ç :")
    driver.find_element_by_id('yzm').send_keys(code)
    driver.find_element_by_id('checkfp').click()
    time.sleep(3)
</code></pre>

<h4 id="3-è‡ªåŠ¨æˆªå›¾">3. è‡ªåŠ¨æˆªå›¾</h4>
<p>è·³è½¬è‡³å‘ç¥¨éªŒè¯é¡µé¢åï¼Œä½¿ç”¨seleniumåº“æ§åˆ¶é¼ æ ‡åœ¨é¡µé¢æ»šåŠ¨è‡³æœ€ä¸Šæ–¹ï¼Œè‡ªåŠ¨æˆªå›¾ï¼Œä»¥å‘ç¥¨å·ç å‘½åï¼Œä¿å­˜åœ¨excelæ–‡ä»¶çš„ç›®å½•ä¸‹çš„â€œæˆªå›¾â€æ–‡ä»¶å¤¹ä¸­ã€‚</p>

<ul>
  <li>
    <font size="2">æ³¨ï¼šç”±äºç½‘é€Ÿç­‰é—®é¢˜ç½‘é¡µè·³è½¬æ…¢ï¼Œå¯èƒ½å‡ºç°æˆªé”™é¡µé¢çš„æƒ…å†µ</font>
  </li>
</ul>

<pre class="prettyprint"><code class="language-py">
def screen_shot(driver,screenshot_save_path,invoice_num):
    
    time.sleep(3)
    
#    ele = driver.find_element_by_class_name('logo')
    # å°†é¼ æ ‡ç§»åŠ¨åˆ°å®šä½çš„å…ƒç´ ä¸Šé¢
#    ActionChains(driver).move_to_element(ele).perform()
#   ä»¥ä¸‹æ“ä½œæ˜¯æ»šåŠ¨é¼ æ ‡å°†ç½‘é¡µç§»åŠ¨è‡³æœ€ä¸Šç«¯ï¼Œä½¿æˆªå›¾å®Œæ•´
    driver.execute_script("""
    (function () {
        var y = 0;
        var step = 100;
        window.scroll(0, 0);

        function f() {
            if (y &lt; document.body.scrollHeight) {
                y += step;
                window.scroll(0, y);
                setTimeout(f, 100);
            } else {
                window.scroll(0, 0);
                document.title += "scroll-done";
            }
        }

        setTimeout(f, 1000);
    })();
""")  
    driver.save_screenshot(os.path.join(screenshot_save_path,'%s.png' % invoice_num))
    print("å‘ç¥¨%sæˆªå›¾æˆåŠŸ" % invoice_num)
    time.sleep(2)
</code></pre>

<h4 id="4-å¾ªç¯æŸ¥éªŒå‘ç¥¨æ•°æ®">4. å¾ªç¯æŸ¥éªŒå‘ç¥¨æ•°æ®</h4>
<pre class="prettyprint"><code class="language-py">
for i in range(len(invoice_info)):
    try:
        invoice_code,invoice_num,date,value = [str(ele) for ele in invoice_info.ix[i,1:]]
        invoice_check(driver,invoice_code,invoice_num,date,value,screenshot_save_path)
        time.sleep(1)
    # æŸ¥éªŒå‘ç¥¨çš„è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼Œåˆ·æ–°ä¸€ä¸‹å°±å¥½äº†
    except StaleElementReferenceException as msg:
        print("æŸ¥æ‰¾å…ƒç´ å¼‚å¸¸%sï¼Œè¯·ç­‰å¾…..."%msg)
        print("é‡æ–°è·å–å…ƒç´ ...")
        driver.refresh()
        i = i+1
driver.close()
print("æˆªå›¾å·²å®Œæˆ!è¯·æ‰“å¼€%sæŸ¥çœ‹ï¼Œæ­£åœ¨å°†æˆªå›¾æ’å…¥wordæ–‡æ¡£......" % screenshot_save_path)
</code></pre>
<h4 id="5-è‡ªåŠ¨ç”Ÿæˆwordæ–‡æ¡£">5. è‡ªåŠ¨ç”Ÿæˆwordæ–‡æ¡£</h4>
<p>æ‰€æœ‰å‘ç¥¨éªŒè¯æˆªå›¾åï¼Œå°†åŒä¸€ä¸ªä¸šåŠ¡é¡¹ä¸‹çš„å‘ç¥¨æ’å…¥wordæ–‡æ¡£ï¼Œä»¥ä¸šåŠ¡ç¼–ç å‘½åï¼Œä¿å­˜åœ¨excelæ–‡ä»¶çš„ç›®å½•ä¸‹çš„â€œæ–‡æ¡£â€æ–‡ä»¶å¤¹ä¸­ï¼Œæ–¹ä¾¿åç»­æ‰“å°æ“ä½œã€‚</p>

<pre class="prettyprint"><code class="language-py">
from docx import Document
from docx.shared import Inches
#å°†åŒä¸€ç¬”ä¸šåŠ¡çš„æˆªå›¾æ”¾å…¥ä¸€ä¸ªwordæ–‡æ¡£ä¸­ï¼Œä»¥ä¸šåŠ¡ç¼–å·å‘½å
for business_no in invoice_info["ä¸šåŠ¡ç¼–å·"].value_counts().index:
    invoice_no = invoice_info["å‘ç¥¨å·ç "][invoice_info["ä¸šåŠ¡ç¼–å·"]==business_no]
    doc = Document()    # docå¯¹è±¡
    doc.add_heading(business_no ,0)

    for invoice_no_i in invoice_no:
        #string = 'æ–‡å­—å†…å®¹'
        images = os.path.join(screenshot_save_path,'%s.png' % invoice_no_i)    # ä¿å­˜åœ¨æœ¬åœ°çš„å›¾ç‰‡
        
        #doc.add_paragraph(string)   # æ·»åŠ æ–‡å­—
        doc.add_picture(images,width=Inches(6))     # æ·»åŠ å›¾, è®¾ç½®å®½åº¦
    doc.save(os.path.join(doc_save_path,'%s.docx' % business_no))     # ä¿å­˜è·¯å¾„   

print("å·²å°†æˆªå›¾æ’å…¥wordæ–‡æ¡£ï¼Œè¯·æ‰“å¼€%sæŸ¥çœ‹!" % doc_save_path)
</code></pre>

<h3 id="æ‰“åŒ…exeæ–‡ä»¶">æ‰“åŒ…exeæ–‡ä»¶</h3>
<p>ä¸ºäº†è®©ä¸æ‡‚ç¨‹åºçš„äººä½¿ç”¨è¯¥ç¨‹åºï¼Œæé«˜å·¥ä½œæ•ˆç‡ï¼Œæœ¬ä»£ç è¿˜å¯ç”¨pyinstalleræ‰“åŒ…æˆexeæ–‡ä»¶ï¼Œæ€»æ–‡ä»¶å¤§æ¦‚700Mã€‚åœ¨cmdæˆ–è€…anaconda promptä¸­è¾“å…¥ä»¥ä¸‹ä»£ç ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pyinstaller -p C:/.../Anaconda2/envs/py3/Lib/site-packages -D invoice_checking.py
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-p æŒ‡å®špythonç¬¬ä¸‰æ–¹åŒ…çš„è·¯å¾„ï¼Œå°†ä»£ç ä¾èµ–çš„åŒ…éƒ½æ‰“åŒ…è¿›å»
-D äº§ç”Ÿä¸€ä¸ªç›®å½•ï¼ˆåŒ…å«å¤šä¸ªæ–‡ä»¶ï¼‰ä½œä¸ºå¯æ‰§è¡Œç¨‹åº
å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼š../dist/invoice_checking/invoice_checking.exe
</code></pre></div></div>

<p>å½“éœ€è¦ä¸€æ¬¡æ€§æŸ¥è¯¢å¤§é‡å‘ç¥¨æ—¶ï¼Œè¯¥ç¨‹åºä¼˜åŠ¿å°±æ˜¾ç¤ºå‡ºæ¥å•¦~(<em>^â–½^</em>)~</p>

<p>è·å–å®Œæ•´ä»£ç è¯·ç‚¹å‡»<a href="https://github.com/Snowing-ST/Invoice-Checking">æ­¤å¤„</a>ã€‚</p>

:ET