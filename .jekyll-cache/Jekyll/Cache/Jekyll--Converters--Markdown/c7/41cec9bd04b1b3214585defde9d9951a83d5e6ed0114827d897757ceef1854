I"2<p>scrapyä¼˜åŠ¿ï¼š</p>
<ol>
  <li>æ–°å»ºçˆ¬è™«é¡¹ç›®æ—¶ï¼Œåªéœ€æ”¹åŠ¨åŸå› æ¡†æ¶ä¸€äº›å†…å®¹ï¼Œæ— éœ€ä»å¤´å†™ä»£ç </li>
  <li>æ‰§è¡Œç¨‹åºæ—¶ï¼Œåœ¨ä¸€å®šèŒƒå›´å†…çˆ¬å–å‡ºé”™è‡ªåŠ¨è·³è¿‡ï¼Œä¸ä¼šæ‰“æ–­ç¨‹åºï¼Œæ— éœ€å®šä¹‰å‡ºé”™è¯†åˆ«å’Œå¤„ç†åŠæ³•</li>
</ol>

<h2 id="å®‰è£…crapy">å®‰è£…crapy</h2>

<p>æ‰“å¼€anaconda promptï¼Œè¾“å…¥<code class="highlighter-rouge">pip install scrapy</code></p>

<h2 id="æ–°å»ºscrapyé¡¹ç›®newsspider">æ–°å»ºscrapyé¡¹ç›®<code class="highlighter-rouge">newsSpider</code></h2>

<h3 id="1-æ‰“å¼€anaconda-promptcdåˆ°åˆ°æŒ‡å®šæ–‡ä»¶å¤¹è¾“å…¥scrapy-startproject-newsspider">1. æ‰“å¼€anaconda promptï¼Œcdåˆ°åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œè¾“å…¥ï¼š<code class="highlighter-rouge">scrapy startproject newsSpider</code>ï¼Œ</h3>
<h3 id="2-å†è¾“å…¥tree-newsspiderå¯çœ‹åˆ°è¯¥æ–‡ä»¶å¤¹ä¸­è‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶">2. å†è¾“å…¥<code class="highlighter-rouge">tree newsSpider</code>å¯çœ‹åˆ°è¯¥æ–‡ä»¶å¤¹ä¸­è‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>newsSpider/
    scrapy.cfg            # deploy configuration file
    newsSpider/             # project's Python module, you'll import your code from here
        __init__.py
        items.py          # project items definition file
        middlewares.py    # project middlewares file
        pipelines.py      # project pipelines file
        settings.py       # project settings file
        spiders/          # a directory where you'll later put your spiders
            __init__.py
</code></pre></div></div>
<h3 id="3-æœ€åcdåˆ°newsspidernewsspiderspidersä¸­è¾“å…¥scrapy-genspider-traderwar-searchsinacomcn">3. æœ€åcdåˆ°<code class="highlighter-rouge">./newsSpider/newsSpider/spiders</code>ä¸­ï¼Œè¾“å…¥<code class="highlighter-rouge">scrapy genspider TraderWar search.sina.com.cn</code></h3>
<p>åˆ™ç”Ÿæˆ<code class="highlighter-rouge">TraderWar.py</code>æ ¸å¿ƒçˆ¬è™«æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€è¡Œä¸º<code class="highlighter-rouge">allowed_domains = ["search.sina.com.cn"]</code>ï¼Œå³æŒ‡å®šäº†çˆ¬è™«ç½‘ç«™ã€‚</p>

<h2 id="æ”¹å†™æ ¸å¿ƒçˆ¬è™«æ–‡ä»¶">æ”¹å†™æ ¸å¿ƒçˆ¬è™«æ–‡ä»¶</h2>

<p><code class="highlighter-rouge">TraderWar.py</code> åˆå§‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">scrapy</span>
<span class="k">class</span> <span class="nc">TraderwarSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"TraderWar"</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s">"search.sina.com.cn"</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://search.sina.com.cn/'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div></div>

<h3 id="1-ç¡®å®šstart_urls">1. ç¡®å®š<code class="highlighter-rouge">start_urls</code></h3>
<p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€search.sina.com.cnï¼Œè¾“å…¥æœç´¢è¯ï¼Œå¦‚â€œä¸­ç¾è´¸æ˜“æˆ˜â€ï¼Œç‚¹å‡»æœç´¢ç»“æœçš„ç¬¬2é¡µï¼Œå¾—åˆ°ç½‘å€
http://search.sina.com.cn/?q=%D6%D0%C3%C0%C3%B3%D2%D7%D5%BD&amp;c=news&amp;from=index&amp;col=&amp;range=&amp;source=&amp;country=&amp;size=&amp;time=&amp;a=&amp;page=2&amp;pf=0&amp;ps=0&amp;dpc=1
å°†page=2ä¸­çš„2æ›¿æ¢æˆä»»ä¸€æ•°å­—ï¼Œåˆ™å¾—åˆ°äº†æ¯ä¸€é¡µæœç´¢çš„ç½‘å€</p>

<h3 id="2-æå–æ¯æ¡æ–°é—»æ ‡é¢˜èƒŒåçš„é“¾æ¥">2. æå–æ¯æ¡æ–°é—»æ ‡é¢˜èƒŒåçš„é“¾æ¥</h3>
<p>æ¯ä¸€ä¸ªæœç´¢é¡µé¢çš„ç½‘å€å°†è¢«ä¼ å…¥åˆ°<code class="highlighter-rouge">parse</code>å‡½æ•°ï¼Œåœ¨æµè§ˆå™¨â€œæ£€æŸ¥â€ä¸­æŸ¥çœ‹ç½‘é¡µæºä»£ç ï¼Œæ‰¾åˆ°æ¯æ¡æ–°é—»çš„æ ‡é¢˜é“¾æ¥çš„xpathè·¯å¾„ï¼Œåˆ™å¯æå–é“¾æ¥</p>
<h3 id="3-æŒ‡å®šé¡µé¢å†…å®¹ä¸­çˆ¬å–çš„å…ƒç´ ">3. æŒ‡å®šé¡µé¢å†…å®¹ä¸­çˆ¬å–çš„å…ƒç´ </h3>
<p>æå–çš„æ–°é—»é“¾æ¥ä¼ å…¥<code class="highlighter-rouge">parse_detail</code>å‡½æ•°ï¼Œscrapyå°†è‡ªåŠ¨è®¿é—®è¿™äº›é“¾æ¥ï¼ˆå³æ–°é—»è¯¦æƒ…é¡µï¼‰ï¼Œåœ¨æµè§ˆå™¨â€œæ£€æŸ¥â€ä¸­æŸ¥çœ‹ç½‘é¡µæºä»£ç ï¼Œæ‰¾åˆ°æ–°é—»æ ‡é¢˜ã€å‘å¸ƒæ—¶é—´ã€æ¥æºã€å…¨æ–‡å†…å®¹ç­‰çš„xpathè·¯å¾„ï¼Œæå–è¿™äº›å…ƒç´ ä¿å­˜è‡³<code class="highlighter-rouge">NewsspiderItem</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">scrapy</span>
<span class="kn">from</span> <span class="nn">newsSpider.items</span> <span class="kn">import</span> <span class="n">NewsspiderItem</span>

<span class="k">class</span> <span class="nc">TradewarSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"TradeWar"</span>
<span class="c1">#    allowed_domains = ["search.sina.com.cn"]
</span>    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">'http://search.sina.com.cn/?q=</span><span class="si">%</span><span class="s">D6</span><span class="si">%</span><span class="s">D0</span><span class="si">%</span><span class="s">C3</span><span class="si">%</span><span class="s">C0</span><span class="si">%</span><span class="s">C3</span><span class="si">%</span><span class="s">B3</span><span class="si">%</span><span class="s">D2</span><span class="si">%</span><span class="s">D7</span><span class="si">%</span><span class="s">D5</span><span class="si">%</span><span class="s">BD&amp;c=news&amp;from=index&amp;col=&amp;range=&amp;source=&amp;country=&amp;size=&amp;time=&amp;a=&amp;page='</span><span class="o">+</span><span class="s">'</span><span class="si">%</span><span class="s">s&amp;pf=2131425448&amp;ps=2134309112&amp;dpc=1'</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span> <span class="c1">#è®¾å®šåªçˆ¬å–å‰20é¡µ
</span>            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//*[@id="result"]/div/div/h2/a/@href'</span><span class="p">):</span> <span class="c1">#æå–é¡µé¢ä¸­æ¯æ¡æ–°é—»çš„æ ‡é¢˜çš„é“¾æ¥
</span>            <span class="n">full_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">href</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span><span class="c1">#è¯¥é“¾æ¥æ˜¯ç›¸å¯¹é“¾æ¥ï¼Œè¦æ”¹æˆå®Œæ•´é“¾æ¥
</span>            <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">full_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_detail</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">parse_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//h1[@class="main-title"]/text()'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#æ ‡é¢˜
</span>        <span class="n">news</span> <span class="o">=</span> <span class="n">NewsspiderItem</span><span class="p">()</span>
        <span class="n">news</span><span class="p">[</span><span class="s">"url"</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span>
        <span class="n">news</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//h1[@class="main-title"]/text()'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">news</span><span class="p">[</span><span class="s">"time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//*[@id="top_bar"]/div/div[2]/span/text()'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">news</span><span class="p">[</span><span class="s">"origin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//*[@id="top_bar"]/div/div[2]/a/text()'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="n">news</span><span class="p">[</span><span class="s">"origin_url"</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//*[@id="top_bar"]/div/div[2]/a/@href'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">news</span><span class="p">[</span><span class="s">"detail"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[@class="article"]/div/p/text()'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span><span class="o">+</span>\
        <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[@class="article"]/p/text()'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span><span class="o">+</span>\
        <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[@class="article"]/div/div/text()'</span><span class="p">))</span>
        <span class="k">yield</span> <span class="n">news</span>
</code></pre></div></div>

<h3 id="4-è¿è¡Œtraderwarpy-å¹¶ä¿å­˜çˆ¬è™«ç»“æœ">4. è¿è¡Œ<code class="highlighter-rouge">TraderWar.py</code> å¹¶ä¿å­˜çˆ¬è™«ç»“æœ</h3>

<p>æ‰“å¼€anaconda promptï¼Œcdåˆ°newsSpider/newsSpiderï¼Œè¿è¡Œ<code class="highlighter-rouge">scrapy crawl TradeWar -o data.csv -s FEED_EXPORT_ENCODING=gbk</code></p>

<p>æˆ–è€…ï¼Œcdåˆ°newsSpider/newsSpider/spidersç›®å½•ä¸‹ï¼Œè¿è¡Œ<code class="highlighter-rouge">scrapy runspider TradeWar.py -o data.csv -s FEED_EXPORT_ENCODING=gbk</code>
<code class="highlighter-rouge">FEED_EXPORT_ENCODING=gbk</code>å¯è§£å†³csvæ–‡ä»¶ä¸­æ–‡ä¹±ç é—®é¢˜ã€‚</p>

<p>çˆ¬å–æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š
<img src="../assets/images/post_images/news-crawl-result.png" alt="news-crawl-result" /></p>

:ET